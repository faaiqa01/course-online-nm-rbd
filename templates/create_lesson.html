{% extends "base.html" %}
{% block content %}
{% set is_edit = lesson is defined and lesson %}
<h2>{{ 'Edit Lesson' if is_edit else 'Add Lesson' }} - {{ course.title }}</h2>
<div class="card-actions">
  <a class="btn secondary" href="{{ url_for('course_detail', course_id=course.id) }}">Back</a>
</div>
<form id="lesson-form" method="post" class="course-form">
  <div class="course-field">
    <label>Title</label>
    <input name="title" value="{{ lesson.title if is_edit else '' }}" required>
  </div>

  <div class="course-field">
    <label for="start_date">Tanggal Mulai</label>
    <input type="datetime-local" id="start_date" name="start_date"
           value="{{ lesson.start_date.strftime('%Y-%m-%dT%H:%M') if is_edit and lesson.start_date else '' }}">
  </div>

  <div class="course-field">
    <label for="duration_minutes">Durasi (dalam menit)</label>
    <input type="number" id="duration_minutes" name="duration_minutes" min="1" placeholder="Contoh: 60 untuk 1 jam"
           value="{{ lesson.duration_minutes if is_edit and lesson.duration_minutes else '' }}">
    <small class="thumbnail-hint">Masukkan durasi materi dalam menit. Contoh: 60 = 1 jam, 90 = 1.5 jam, 120 = 2 jam</small>
  </div>

  <div class="course-field">
    <label for="category">Kategori Materi</label>
    <select id="category" name="category">
      <option value="" {% if not (is_edit and (lesson.video_url or lesson.meeting_url)) %}selected{% endif %}>Pilih Kategori</option>
      <option value="video" {% if is_edit and lesson.video_url %}selected{% endif %}>Video URL</option>
      <option value="meeting" {% if is_edit and lesson.meeting_url %}selected{% endif %}>Pertemuan</option>
    </select>
  </div>

  <div id="video-url-field" class="course-field">
    <label>Video URL</label>
    <input name="video_url" placeholder="https://..." value="{{ lesson.video_url if is_edit else '' }}">
  </div>

  <div id="meeting-url-field" class="course-field">
    <label>URL Pertemuan</label>
    <input type="text" name="meeting_url" placeholder="https://..." value="{{ lesson.meeting_url if is_edit else '' }}">
  </div>

  <div class="course-field">
    <label>Content</label>
    <textarea name="content" rows="4">{{ lesson.content if is_edit else '' }}</textarea>
  </div>

  <div class="course-field">
    <label>Yang Akan Dipelajari (Learning Outcomes)</label>
    <div id="outcomes-container">
      {% if existing_outcomes %}
        {% for outcome in existing_outcomes %}
      <div class="outcome-item">
        <input type="text" name="outcomes[]" value="{{ outcome.outcome_text }}" placeholder="Tulis poin yang akan dipelajari" class="outcome-input">
        <button type="button" class="btn-remove-outcome" onclick="removeOutcome(this)">✕</button>
      </div>
        {% endfor %}
      {% else %}
      <div class="outcome-item">
        <input type="text" name="outcomes[]" placeholder="Contoh: Memahami konsep dasar variabel" class="outcome-input">
        <button type="button" class="btn-remove-outcome" onclick="removeOutcome(this)" style="display:none;">✕</button>
      </div>
      {% endif %}
    </div>
    <button type="button" class="btn secondary" onclick="addOutcome()" style="margin-top: 0.5rem;">+ Tambah Outcome</button>
    <small class="thumbnail-hint">Tambahkan poin-poin apa yang akan dipelajari pada materi ini.</small>
  </div>

  <div class="course-field">
    <label>Keterampilan yang akan Anda peroleh</label>
    <div id="skills-container">
      {% if existing_skills %}
        {% for skill in existing_skills %}
      <div class="skill-item">
        <input type="text" name="skills[]" value="{{ skill.skill_text }}" placeholder="Tulis keterampilan yang diperoleh" class="skill-input">
        <button type="button" class="btn-remove-skill" onclick="removeSkill(this)">✕</button>
      </div>
        {% endfor %}
      {% else %}
      <div class="skill-item">
        <input type="text" name="skills[]" placeholder="Contoh: Pemrograman Python Dasar" class="skill-input">
        <button type="button" class="btn-remove-skill" onclick="removeSkill(this)" style="display:none;">✕</button>
      </div>
      {% endif %}
    </div>
    <button type="button" class="btn secondary" onclick="addSkill()" style="margin-top: 0.5rem;">+ Tambah Keterampilan</button>
    <small class="thumbnail-hint">Tambahkan keterampilan spesifik yang akan dikuasai siswa.</small>
  </div>
</form>
<div class="card-actions">
  <button class="btn" type="submit" form="lesson-form">Simpan</button>
  {% if is_edit %}
    <form method="post" action="{{ url_for('delete_lesson', course_id=course.id, lesson_id=lesson.id) }}" style="display:inline" onsubmit="return confirm('Yakin ingin menghapus lesson ini?');">
      <button class="btn danger" type="submit">Hapus Materi</button>
    </form>
  {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('category');
    const videoUrlField = document.getElementById('video-url-field');
    const meetingUrlField = document.getElementById('meeting-url-field');

    function toggleFields() {
      if (categorySelect.value === 'video') {
        videoUrlField.style.display = 'block';
        meetingUrlField.style.display = 'none';
      } else if (categorySelect.value === 'meeting') {
        videoUrlField.style.display = 'none';
        meetingUrlField.style.display = 'block';
      } else {
        videoUrlField.style.display = 'none';
        meetingUrlField.style.display = 'none';
      }
    }

    categorySelect.addEventListener('change', toggleFields);
    toggleFields(); // Initial call to set the correct fields on page load
    updateRemoveButtons(); // Initialize outcome buttons
    updateSkillRemoveButtons(); // Initialize skill buttons
  });

  // Learning Outcomes functionality
  function addOutcome() {
    const container = document.getElementById('outcomes-container');
    const newItem = document.createElement('div');
    newItem.className = 'outcome-item';
    newItem.innerHTML = `
      <input type="text" name="outcomes[]" placeholder="Tulis poin yang akan dipelajari" class="outcome-input">
      <button type="button" class="btn-remove-outcome" onclick="removeOutcome(this)">✕</button>
    `;
    container.appendChild(newItem);
    updateRemoveButtons();
  }

  function removeOutcome(btn) {
    const item = btn.closest('.outcome-item');
    if (item) {
      item.remove();
      updateRemoveButtons();
    }
  }

  function updateRemoveButtons() {
    const items = document.querySelectorAll('.outcome-item');
    items.forEach((item, index) => {
      const btn = item.querySelector('.btn-remove-outcome');
      if (btn) {
        btn.style.display = items.length > 1 ? 'inline-block' : 'none';
      }
    });
  }

  // Skills functionality
  function addSkill() {
    const container = document.getElementById('skills-container');
    const newItem = document.createElement('div');
    newItem.className = 'skill-item';
    newItem.innerHTML = `
      <input type="text" name="skills[]" placeholder="Tulis keterampilan yang diperoleh" class="skill-input">
      <button type="button" class="btn-remove-skill" onclick="removeSkill(this)">✕</button>
    `;
    container.appendChild(newItem);
    updateSkillRemoveButtons();
  }

  function removeSkill(btn) {
    const item = btn.closest('.skill-item');
    if (item) {
      item.remove();
      updateSkillRemoveButtons();
    }
  }

  function updateSkillRemoveButtons() {
    const items = document.querySelectorAll('.skill-item');
    items.forEach((item, index) => {
      const btn = item.querySelector('.btn-remove-skill');
      if (btn) {
        btn.style.display = items.length > 1 ? 'inline-block' : 'none';
      }
    });
  }
</script>
{% endblock %}