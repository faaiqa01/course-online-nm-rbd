{% extends "base.html" %}

{% block content %}
<div class="container" style="max-width: 700px; margin: 40px auto; padding: 20px;">
    <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 6px 20px rgba(0,0,0,0.06);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:18px;">
            <div>
                <h2 style="margin:0;">Nota Pembayaran</h2>
                <div style="color:#6c757d; font-size:14px;">Order ID: <strong>{{ payment.order_id }}</strong></div>
                <div id="countdown" style="color:#dc3545; font-size:14px; margin-top:6px;">
                    {% if expiry_iso %}
                            Sisa waktu: <span id="countdown-timer">-</span>
                        {% else %}
                            &nbsp;
                        {% endif %}
                </div>
            </div>
            <div style="text-align:right;">
                <div style="color:#6c757d; font-size:12px;">Tanggal</div>
                <div>{{ payment.created_at.strftime('%d %b %Y %H:%M') if payment.created_at else '-' }}</div>
            </div>
        </div>

        <div style="border-top:1px solid #eee; padding-top: 12px; margin-top:8px;">
            {% if payment.order_id.startswith('CART-') %}
                <div style="margin-bottom:8px; color:#6c757d;">Items</div>
                {% if payment.cart_courses %}
                    <ul style="margin:0 0 12px 18px; padding:0; color:#333;">
                        {% for c in payment.cart_courses %}
                        <li>{{ c.title }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    {# Try to show titles saved in payment_data if available. Avoid using unsupported try/except tags in Jinja. #}
                    {% set raw = payment.payment_data %}
                    {% if raw is mapping and raw.get('course_titles') %}
                        <ul style="margin:0 0 12px 18px; padding:0; color:#333;">
                        {% for t in raw.get('course_titles') %}
                            <li>{{ t }}</li>
                        {% endfor %}
                        </ul>
                    {% else %}
                        <div style="color:#333; margin-bottom:12px;">Multiple courses</div>
                    {% endif %}
                {% endif %}
            {% else %}
                <div style="margin-bottom:8px; color:#6c757d;">Course</div>
                <div style="color:#333; margin-bottom:12px;"><strong>{{ payment.course.title if payment.course else 'N/A' }}</strong></div>
            {% endif %}

            <div style="display:flex; justify-content:space-between; align-items:center; border-top:1px dashed #eee; padding-top:12px;">
                <div style="color:#6c757d;">Total Bayar</div>
                <div style="color:#28a745; font-weight:700;">Rp {{ "{:,.0f}".format(payment.gross_amount) }}</div>
            </div>

            <div style="margin-top:18px; text-align:center;">
                {% if payment.transaction_status == 'pending' %}
                    <button id="pay-now" type="button" style="background:#007bff;color:white;border:none;padding:12px 28px;border-radius:8px;font-size:16px;">Bayar Sekarang</button>
                {% else %}
                    <a href="{{ url_for('payment.payment_success') }}?order_id={{ payment.order_id }}" class="btn" style="background:#17a2b8;color:white;padding:10px 20px;border-radius:6px;text-decoration:none;">Lihat Nota Selesai</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if payment.transaction_status == 'pending' %}
<script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="{{ midtrans_client_key }}"></script>
<script>
document.getElementById('pay-now').addEventListener('click', function(){
    const btn = this;
    const originalText = btn.innerText || 'Bayar Sekarang';
    btn.disabled = true;
    btn.innerText = 'Membuat transaksi...';

    fetch('/payment/retry/{{ payment.order_id }}', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
    .then(r => r.json())
    .then(data => {
        if (data.success && data.snap_token) {
            // Do NOT update the displayed countdown here — keep the original invoice expiry running.
            // The retry creates a separate transaction; we keep showing the original payment's remaining time.
            window.snap.pay(data.snap_token, {
                onSuccess: function(result){ window.location.href = '/payment/success?order_id=' + data.order_id; },
                onPending: function(result){ window.location.href = '/payment/history'; },
                onError: function(result){
                    // re-enable button in case of immediate error
                    btn.disabled = false;
                    btn.innerText = originalText;
                    alert('Pembayaran gagal.');
                    window.location.href = '/cart';
                },
                onClose: function(){
                    // User closed popup — mark payment as failed on server and restore button
                    fetch('/payment/mark-failed/{{ payment.order_id }}', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
                    .then(r => r.json()).then(res => {
                        // ignore result, just inform user
                        btn.disabled = false;
                        btn.innerText = originalText;
                        alert(res && res.success ? 'Pembayaran dibatalkan.' : (res.message || 'Pembayaran dibatalkan.'));
                    }).catch(err => {
                        btn.disabled = false;
                        btn.innerText = originalText;
                        alert('Anda menutup popup pembayaran. Cek Riwayat Pembayaran.');
                    });
                }
            });
        } else {
            alert(data.message || 'Gagal membuat transaksi');
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }).catch(function(err){
        alert('Error: ' + err);
        btn.disabled = false;
        btn.innerText = originalText;
    });
});

// Countdown helper
function startCountdown(expiryIso) {
    try {
        if (!expiryIso) return;
        // Ensure we treat time as UTC
        let iso = expiryIso;
        if (!iso.endsWith('Z')) iso = iso + 'Z';
        const end = new Date(iso).getTime();
        const el = document.getElementById('countdown-timer');
        if (!el) return;
        function update() {
            const now = Date.now();
            let diff = Math.max(0, end - now);
            const hrs = Math.floor(diff / (1000*60*60));
            diff -= hrs * (1000*60*60);
            const mins = Math.floor(diff / (1000*60));
            diff -= mins * (1000*60);
            const secs = Math.floor(diff / 1000);
            el.innerText = String(hrs).padStart(2,'0') + ':' + String(mins).padStart(2,'0') + ':' + String(secs).padStart(2,'0');
            if (end <= Date.now()) {
                clearInterval(timerInterval);
            }
        }
        update();
        const timerInterval = setInterval(update, 1000);
    } catch (e) { console.error(e); }
}

// init countdown from server-rendered expiry if present
document.addEventListener('DOMContentLoaded', function(){
    const initialExpiry = "{{ expiry_iso or '' }}";
    if (initialExpiry) startCountdown(initialExpiry);
});
</script>
{% endif %}

{% endblock %}
